#version 330 core
const int f=80;const float v=1280,y=720;uniform float iTime;uniform vec4 sp[(f+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const vec3 o=normalize(vec3(1.,1.1,1.));const float e=99999.;vec2 p[4]=vec2[4](normalize(vec2(.23,.65)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.83)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,i=0.;for(int y=0;y<4;y++){float s=v.x*p[y].x+v.z*p[y].y;s=s*(4.-float(y)*.51013)+iTime;float n=1./(float(y)+1.);f+=n*sin(s-.3*cos(s));i+=n*cos(s-.3*sin(s));}return vec3(f,0.,i);}bool t(vec3 f,vec3 e,vec3 v,float y,out float i){vec3 s=v-e;float n=dot(s,f);if(n<0.)return false;else{float t=length(s),o=t*t-n*n;if(o>y)return false;else{float r=sqrt(y-o);i=n-r;return true;}}}float t(vec2 f,out float v){vec4 s=texture(terrain,f/512.);v=s.y;return s.x*60.-12.1;}void t(vec3 f,vec3 e,out float v,out float i){vec3 s=(vec3(0.)-f)/e,o=(vec3(512.)-f)/e;v=max(min(s.x,o.x),min(s.z,o.z));i=min(max(s.x,o.x),max(s.z,o.z));}bool t(vec3 v,vec3 s,out float f,out vec3 i,out vec3 o,out float y,out float n){float z,e;t(v,s,z,e);if(e<z)return false;float r=max(0.,z);v=v+r*s;vec2 x,m,c;c=sign(s.xz);m=1./s.xz*c;x=m*(max(c,0)-fract(v.xz)*c);if(any(isinf(x)||isinf(m)))return false;vec2 d=floor(v.xz);float p=v.y,u=t(d,n);y=0.;for(f=0.;f<e-r;){vec2 k=vec2(float(x.x<x.y),float(x.x>=x.y));f=dot(x,k);float g=v.y+s.y*f;d=d+c*k;x=x+m*k;if(u>g)return i=vec3(.2,.071,.01)+step(27,u)*vec3(.6,-.06,0),y=1.2,o=vec3(0,1.,0),f=(u-v.y)/s.y,true;u=t(d,n);if(u>g){y=1.5;i=vec3(.2,.2,.2)+step(40,u)*vec3(0.,-.03,-.1);if(n==1.){float a=25.31;if(g<a)n=0.;}o=vec3(-c.x*k.x,0,-c.y*k.y);return true;}}return false;}float t(float f,vec3 v,vec3 o){float i=(1.-f)/(1.+f);i*=i;float y=-dot(v,o),e=1.-y,s=i+(1.-i)*e*e*e*e*e;return s;}const vec3 i=vec3(5e-06,1.5e-05,.00027)*15.,s=vec3(.00015,.00015,.00027)*15.;vec3 n(float f){return exp(-f*(i+s));}vec3 n(float f,float v){float y=.0003/16.*3.14159*(1.+v*v);vec3 e=1./(i+s)*(1.-exp(-f*s));float n=.476;vec3 x=vec3(.002,.0008,.0002)*(1.-n)*(1.-n)/(12.5664*pow(1.+n*n-2.*n*v,1.5));float k=20./(i.x+s.x)*(1.-exp(-f*s.x));return y*e+x*k;}void main(){vec2 s=2.*(gl_FragCoord.xy/y)-vec2(v/y,1.);vec4 i=cos(sp[161]),c=sin(sp[161]);mat3 x=mat3(i.y,0,-c.y,-c.x*c.y,i.x,-c.x*i.y,i.x*c.y,c.x,i.y*i.x);vec3 r=x*vec3(s,-2.),z=sp[160].xyz;r+=z;vec3 m=normalize(r-z);float k=1.;vec3 d=vec3(0);for(int u=2;u>0;u--){vec3 p,g,a,b;float w,l=0.,C=e;for(int T=0;T<f;T++){float F;if(t(m,z,sp[T*2].xyz,sp[T*2].w,F)){if(F<C)C=F,a=z+C*m,g=normalize(a-sp[T*2].xyz),b=sp[T*2+1].xyz,w=sp[T*2+1].w,l=t(w,g,m);}}float T;vec3 F,D;float q;if(t(z,m,T,F,D,w,q)){if(T<C){if(q==1.){float h=25.91;vec3 Z=(z-vec3(386.,h,447.))*512.;float Y;if(t(Z,m*512,Y,F,D,w,q))C=T+Y/512.,b=F,b.z=b.z*2.;else{C=T*2.02;z=z+m*C;continue;}}else C=T,b=F;g=D;a=z+m*C*.9999;l=t(w,g,m);}}T=(-.5-z.y)/m.y;if(m.y<0.&&T<=C){a=z+m*T*.9999;g=vec3(0.,1.f,0.f)+t(a)*.01;g=normalize(g);l=t(1.1,g,m);vec3 h=refract(m,g,1.-l);b=vec3(.05,.05,.15);if(t(a,h*100,T,F,D,w,q))b+=F*exp(-T*40.);}p=reflect(normalize(m),g);if(C>=e){d+=n(C,dot(o,m))*k;break;}bool h=t(a,o,T,F,D,w,q);if(!h){for(int Z=0;Z<f;Z++){if(t(o,a,sp[Z*2].xyz,sp[Z*2].w,T)){h=true;break;}}}if(!h){float Z=dot(o,g);vec3 Y=normalize(o-m);float X=pow(dot(g,Y),121.);X=clamp(X,0.,1.);F=vec3(X)+b*Z;}else F=b*.02;F*=n(C);F+=n(C,dot(o,m));d+=F*k*(1.-l);k=k*l;m=p;z=a;}fragColor=vec4(pow(d,vec3(1./2.2)),1.);}