pub static frag_shader_src : &'static str = "
#version 330 core
const int f=80;const float v=1280,o=720;uniform float iTime;uniform vec4 sp[(f+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const vec3 z=normalize(vec3(1.,1.1,1.));const float e=99999.;vec2 p[4]=vec2[4](normalize(vec2(.23,.6556)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.826)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,i=0.;for(int e=0;e<4;e++){float z=v.x*p[e].x+v.z*p[e].y;z=z*(4.-float(e)*.51013)+iTime;float s=1./(float(e)+1.);f+=s*sin(z-.3*cos(z));i+=s*cos(z-.3*sin(z));}return vec3(f,0.,i);}float t(vec3 f,vec3 v,float z,out vec3 i,out vec3 r){if(f.y>=0.)return e;float s=(z-v.y)/f.y;r=vec3(0.,1.f,0.f);i=v+f*s;return s;}float t(float f,vec3 v,vec3 e,vec3 z,float i,int s,out vec3 c,out vec3 o,out int x){vec3 t=z-e;float r=dot(t,v);if(r<0.)return f;else{float m=length(t),n=m*m-r*r;if(n>i)return f;else{float y=sqrt(i-n),d=r-y;if(d<f)return c=e+d*v,o=normalize(c-z),x=s,d;else return f;}}}bool t(vec3 f,vec3 e,vec3 v,float z){vec3 i=v-e;float s=dot(i,f);if(s<0.)return false;else{float r=length(i),o=r*r-s*s;if(o>z)return false;else return true;}}float t(vec2 f,out float v,out float i){vec4 s=texture(terrain,f/512.);v=s.x*5.;i=s.y;return s.x*60.-12.1;}void t(vec3 f,vec3 v,out float z,out float s,out float o,out vec3 i,out float r,out float m,out float c,out vec3 e){if(f.x>0.)z=1.,s=1./f.x,o=s*(1.-fract(v.x));else z=-1.,s=1./-f.x,o=s*fract(v.x);if(f.z>0.)r=1.,m=1./f.z,c=m*(1.-fract(v.z));else r=-1.,m=1./-f.z,c=m*fract(v.z);i=vec3(-z,0,0);e=vec3(0,0,-r);}void i(vec3 f,vec3 v,out float z,out float i){float e=-1000.,s=1000.;if(v.x!=0.){float c=-f.x/v.x,o=(512.-f.x)/v.x;e=max(e,min(c,o));s=min(s,max(c,o));}if(v.z!=0.){float c=-f.z/v.z,o=(512.-f.z)/v.z;e=max(e,min(c,o));s=min(s,max(c,o));}z=e;i=s;}bool i(vec3 v,vec3 f,out float z,out vec3 s,out vec3 o,out float e,out float c){float x,n;vec3 r=f-v;i(v,r,x,n);if(n<x)return false;float y=max(0.,x);v=v+y*r;float m,d,p;vec3 l;float w,g,k;vec3 a;t(r,v,m,d,p,l,w,g,k,a);if(isinf(p)||isinf(k))return false;if(isinf(d)||isinf(g))return false;float u=floor(v.x),b=floor(v.z),C=0.,T=v.y,F,h=t(vec2(u,b),F,c);e=0.;for(z=0.;z<n-y;){if(p<k)z=p,C=v.y+r.y*p,p=p+d,u=u+m,o=l;else z=k,C=v.y+r.y*k,k=k+g,b=b+w,o=a;if(h>C){s=vec3(F/40.,F/40.,1.);if(F<=2.5)s=vec3(.2,.071,.01),e=1.1;else s=vec3(.8,.01,.01),e=1.5;o=vec3(0,1.,0);z=(h-v.y)/r.y;return true;}h=t(vec2(u,b),F,c);if(h>C){if(F>=3.5)s=vec3(.2,.171,.01),e=1.5;else s=vec3(.2,.2,.2),e=1.5;if(c==1.){float D=25.31;if(C<D)c=0.;}return true;}}return false;}float i(float f,vec3 v,vec3 o){float e=(1.-f)/(1.+f);e*=e;float z=-dot(v,o),s=1.-z,c=e+(1.-e)*s*s*s*s*s;return c;}const vec3 c=vec3(5e-06,1.5e-05,.00027)*15.,s=vec3(.00015,.00015,.00027)*15.;vec3 i(float f){return exp(-f*(c+s));}vec3 i(float f,float z){float v=.0003/16.*3.14159*(1.+z*z);vec3 e=vec3(1./(c.x+s.x)*(1.-exp(-f*s.x)),1./(c.y+s.y)*(1.-exp(-f*s.y)),1./(c.z+s.z)*(1.-exp(-f*s.z)));float r=.476;vec3 i=vec3(.002,.0008,.0002)*(1.-r)*(1.-r)/(12.5664*pow(1.+r*r-2.*r*z,1.5));float o=20./(c.x+s.x)*(1.-exp(-f*s.x));return v*e+i*o;}void main(){vec2 s=2.*(gl_FragCoord.xy/o)-vec2(v/o,1.);vec3 c=vec3(s,-2.);float r=sp[161].y;mat3 m=mat3(cos(r),0,-sin(r),0,1,0,sin(r),0,cos(r));float x=sp[161].x;mat3 y=mat3(1,0,0,0,cos(x),-sin(x),0,sin(x),cos(x));float n=sp[161].z;mat3 p=mat3(cos(n),-sin(n),0,sin(n),cos(n),0,0,0,1);m=m*y*p;vec3 l=sp[160].xyz,d=m*c,k=l;d+=l;vec3 u=normalize(d-k);float b=1.;vec3 g=vec3(0,0,0);for(int h=2;h>0;h--){vec3 w,F,C,a;float T,D=0.;int q=-1;float Z=e;for(int Y=0;Y<f;Y++)Z=t(Z,u,k,sp[Y*2].xyz,sp[Y*2].w,Y,C,F,q);if(q!=-1)a=sp[q*2+1].xyz,T=sp[q*2+1].w,D=i(T,F,u),w=reflect(u,F);vec3 Y=k+u;float X;vec3 W,V;float U;if(i(k,Y,X,W,V,T,U)){if(X<Z){if(U==1.){float S=25.91;vec3 R=vec3(386.,S,447.),Q=(k-R)*512.,P=(Y-R)*512.;float O;if(i(Q,P,O,W,V,T,U))Z=X+O/512.,a=W,a.z=a.z*2.,F=V,C=k+u*Z*.9999,D=i(T,F,u),w=reflect(normalize(u),F);else{Z=X*2.02;k=k+u*Z;continue;}}else Z=X,a=W,F=V,C=k+u*Z*.9999,D=i(T,F,u),w=reflect(normalize(u),F);}}vec3 O;float S=t(u,k,-.5,O,V);if(S<=Z){C=k+u*S*.9999;F=V+t(C)*.01;F=normalize(F);D=i(1.1,F,u);w=reflect(u,F);q=0;vec3 R=refract(u,F,1.-D);float P;a=vec3(.05,.05,.15);if(i(C,C+R*100.,P,W,V,T,U))a+=W*exp(-P*40.);q=0;}vec3 R=vec3(0,0,0);if(Z>=e){R+=i(Z,dot(z,u));g+=R*b;break;}bool P=false;vec3 Q=C+z*5.;if(i(C,Q,X,W,V,T,U))P=true;if(!P){for(int N=0;N<f;N++){if(t(z,C,sp[N*2].xyz,sp[N*2].w)){P=true;break;}}}if(!P){vec3 N=reflect(-z,F),M=-u;float L=dot(z,F);vec3 K=normalize(M+z);float J=pow(dot(F,K),121.);J=clamp(J,0.,1.);vec3 I=a*L;R+=vec3(J,J,J)+I;}else R+=a*.02;R*=i(Z);R+=i(Z,dot(z,u));g+=R*b*(1.-D);b=b*D;u=w;k=C;}vec3 F=pow(g,vec3(1./2.2));fragColor=vec4(F,1.);}\0\0";
//const int v=80;const float f=1280,o=720;uniform float iTime;uniform vec4 sp[(v+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const vec3 z=normalize(vec3(1.,1.1,1.));const float e=99999.;vec2 p[4]=vec2[4](normalize(vec2(.23,.6556)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.826)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,i=0.;for(int z=0;z<4;z++){float e=v.x*p[z].x+v.z*p[z].y;e=e*(4.-float(z)*.51013)+iTime;float r=1./(float(z)+1.);f+=r*sin(e-.3*cos(e));i+=r*cos(e-.3*sin(e));}return vec3(f,0.,i);}float t(vec3 v,vec3 f,float z,out vec3 i,out vec3 r){if(v.y>=0.)return e;float x=(z-f.y)/v.y;r=vec3(0.,1.f,0.f);i=f+v*x;return x;}float t(float f,vec3 v,vec3 e,vec3 z,float i,int r,out vec3 x,out vec3 o,out int s){vec3 y=z-e;float m=dot(y,v);if(m<0.)return f;else{float t=length(y),n=t*t-m*m;if(n>i)return f;else{float d=sqrt(i-n),c=m-d;if(c<f)return x=e+c*v,o=normalize(x-z),s=r,c;else return f;}}}bool t(vec3 f,vec3 e,vec3 v,float z){vec3 i=v-e;float x=dot(i,f);if(x<0.)return false;else{float r=length(i),o=r*r-x*x;if(o>z)return false;else return true;}}float t(vec2 f,out float v,out float i){vec4 r=texture(terrain,f/512.);v=r.x*5.;i=r.y;return r.x*60.-12.1;}void t(vec3 f,vec3 v,out float r,out float o,out float z,out vec3 i,out float x,out float s,out float e,out vec3 m){if(f.x>0.)r=1.,o=1./f.x,z=o*(1.-fract(v.x)),i=vec3(-1.,0,0);else r=-1.,o=1./-f.x,z=o*fract(v.x),i=vec3(1.,0,0);if(f.z>0.)x=1.,s=1./f.z,e=s*(1.-fract(v.z)),m=vec3(0,0,-1.);else x=-1.,s=1./-f.z,e=s*fract(v.z),m=vec3(0,0,1.);}float n(vec3 v){return max(max(v.x,v.y),v.z);}float s(vec3 v){return min(min(v.x,v.y),v.z);}void n(vec3 f,vec3 v,out float z,out float i){float e=-1000.,o=1000.;if(v.x!=0.){float x=-f.x/v.x,s=(512.-f.x)/v.x;e=max(e,min(x,s));o=min(o,max(x,s));}if(v.z!=0.){float x=-f.z/v.z,s=(512.-f.z)/v.z;e=max(e,min(x,s));o=min(o,max(x,s));}z=e;i=o;}bool n(vec3 v,vec3 f,out float i,out vec3 r,out vec3 o,out float e,out float z){float x,s;vec3 m=f-v;n(v,m,x,s);if(s<x)return false;float y=max(0.,x);v=v+y*m;float c,d,p;vec3 l;float w,g,k;vec3 a;t(m,v,c,d,p,l,w,g,k,a);if(isinf(p)||isinf(k))return false;if(isinf(d)||isinf(g))return false;float u=floor(v.x),b=floor(v.z),C=0.,T=v.y,F,h=t(vec2(u,b),F,z);e=0.;for(i=0.;i<s-y;){if(p<k)i=p,C=v.y+m.y*p,p=p+d,u=u+c,o=l;else i=k,C=v.y+m.y*k,k=k+g,b=b+w,o=a;if(h>C){r=vec3(F/40.,F/40.,1.);if(F<=2.5)r=vec3(.2,.071,.01),e=1.1;else r=vec3(.8,.01,.01),e=1.5;o=vec3(0,1.,0);i=(h-v.y)/m.y;return true;}h=t(vec2(u,b),F,z);if(h>C){if(F>=3.5)r=vec3(.2,.171,.01),e=1.5;else r=vec3(.2,.2,.2),e=1.5;if(z==1.){float D=25.31;if(C<D)z=0.;}return true;}}return false;}float n(float f,vec3 v,vec3 o){float e=(1.-f)/(1.+f);e*=e;float z=-dot(v,o),s=1.-z,i=e+(1.-e)*s*s*s*s*s;return i;}const vec3 i=vec3(5e-06,1.5e-05,.00027)*15.,x=vec3(.00015,.00015,.00027)*15.;vec3 r(float f){return exp(-f*(i+x));}vec3 n(float f,float z){float v=.0003/16.*3.14159*(1.+z*z);vec3 e=vec3(1./(i.x+x.x)*(1.-exp(-f*x.x)),1./(i.y+x.y)*(1.-exp(-f*x.y)),1./(i.z+x.z)*(1.-exp(-f*x.z)));float s=.476;vec3 r=vec3(.002,.0008,.0002)*(1.-s)*(1.-s)/(12.5664*pow(1.+s*s-2.*s*z,1.5));float o=20./(i.x+x.x)*(1.-exp(-f*x.x));return v*e+r*o;}void main(){vec2 i=2.*(gl_FragCoord.xy/o)-vec2(f/o,1.);vec3 x=vec3(i,-2.);float s=sp[161].y;mat3 m=mat3(cos(s),0,-sin(s),0,1,0,sin(s),0,cos(s));float y=sp[161].x;mat3 p=mat3(1,0,0,0,cos(y),-sin(y),0,sin(y),cos(y));float c=sp[161].z;mat3 k=mat3(cos(c),-sin(c),0,sin(c),cos(c),0,0,0,1);m=m*p*k;vec3 d=sp[160].xyz,u=m*x,b=d;u+=d;vec3 g=normalize(u-b);float l=1.;vec3 w=vec3(0,0,0);for(int h=2;h>0;h--){vec3 F,C,a,T;float D,q=0.;int Z=-1;float Y=e;for(int X=0;X<v;X++)Y=t(Y,g,b,sp[X*2].xyz,sp[X*2].w,X,a,C,Z);if(Z!=-1)T=sp[Z*2+1].xyz,D=sp[Z*2+1].w,q=n(D,C,g),F=reflect(g,C);vec3 X=b+g;float W;vec3 V,U;float S;if(n(b,X,W,V,U,D,S)){if(W<Y){if(S==1.){float R=25.91;vec3 Q=vec3(386.,R,447.),P=(b-Q)*512.,O=(X-Q)*512.;float N;if(n(P,O,N,V,U,D,S))Y=W+N/512.,T=V,T.z=T.z*2.,C=U,a=b+g*Y*.9999,q=n(D,C,g),F=reflect(normalize(g),C);else{Y=W*2.02;b=b+g*Y;continue;}}else Y=W,T=V,C=U,a=b+g*Y*.9999,q=n(D,C,g),F=reflect(normalize(g),C);}}vec3 N;float R=t(g,b,-.5,N,U);if(R<=Y){a=b+g*R*.9999;C=U+t(a)*.01;C=normalize(C);q=n(1.1,C,g);F=reflect(g,C);Z=0;vec3 Q=refract(g,C,1.-q);float O;T=vec3(.05,.05,.15);if(n(a,a+Q*100.,O,V,U,D,S))T+=V*exp(-O*40.);Z=0;}vec3 Q=vec3(0,0,0);if(Y>=e){Q+=n(Y,dot(z,g));w+=Q*l;break;}bool O=false;vec3 P=a+z*5.;if(n(a,P,W,V,U,D,S))O=true;if(!O){for(int M=0;M<v;M++){if(t(z,a,sp[M*2].xyz,sp[M*2].w)){O=true;break;}}}if(!O){vec3 M=reflect(-z,C),L=-g;float K=dot(z,C);vec3 J=normalize(L+z);float I=pow(dot(C,J),121.);I=clamp(I,0.,1.);vec3 H=T*K;Q+=vec3(I,I,I)+H;}else Q+=T*.02;Q*=r(Y);Q+=n(Y,dot(z,g));w+=Q*l*(1.-q);l=l*q;g=F;b=a;}vec3 C=pow(w,vec3(1./2.2));fragColor=vec4(C,1.);}\0\0";
//const int v=80;const float f=1280,o=720;uniform float iTime;uniform vec4 sp[(v+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const vec3 z=normalize(vec3(1.,1.1,1.));const float e=99999.;vec2 p[4]=vec2[4](normalize(vec2(.23,.6556)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.826)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,i=0.;for(int z=0;z<4;z++){float e=v.x*p[z].x+v.z*p[z].y;e=e*(4.-float(z)*.51013)+iTime;float r=1./(float(z)+1.);f+=r*sin(e-.3*cos(e));i+=r*cos(e-.3*sin(e));}return vec3(f,0.,i);}float t(vec3 v,vec3 f,float z,out vec3 i,out vec3 r){if(v.y>=0.)return e;float c=(z-f.y)/v.y;r=vec3(0.,1.f,0.f);i=f+v*c;return c;}float t(float f,vec3 v,vec3 e,vec3 z,float i,int r,out vec3 c,out vec3 o,out int s){vec3 x=z-e;float m=dot(x,v);if(m<0.)return f;else{float t=length(x),y=t*t-m*m;if(y>i)return f;else{float n=sqrt(i-y),d=m-n;if(d<f)return c=e+d*v,o=normalize(c-z),s=r,d;else return f;}}}bool t(vec3 f,vec3 e,vec3 v,float z){vec3 i=v-e;float c=dot(i,f);if(c<0.)return false;else{float r=length(i),o=r*r-c*c;if(o>z)return false;else return true;}}float t(vec2 f,out float v,out float i){vec4 r=texture(terrain,f/512.);v=r.x*5.;i=r.y;return r.x*60.-12.1;}void t(vec3 f,vec3 v,out float r,out float o,out float z,out vec3 i,out float e,out float s,out float c,out vec3 x){if(f.x>0.)r=1.,o=1./f.x,z=o*(1.-fract(v.x)),i=vec3(-1.,0,0);else r=-1.,o=1./-f.x,z=o*fract(v.x),i=vec3(1.,0,0);if(f.z>0.)e=1.,s=1./f.z,c=s*(1.-fract(v.z)),x=vec3(0,0,-1.);else e=-1.,s=1./-f.z,c=s*fract(v.z),x=vec3(0,0,1.);}float n(vec3 v){return max(max(v.x,v.y),v.z);}float s(vec3 v){return min(min(v.x,v.y),v.z);}void n(vec3 f,vec3 v,out float z,out float i){float e=-1000.,o=1000.;if(v.x!=0.){float r=-f.x/v.x,x=(512.-f.x)/v.x;e=max(e,min(r,x));o=min(o,max(r,x));}if(v.z!=0.){float r=-f.z/v.z,x=(512.-f.z)/v.z;e=max(e,min(r,x));o=min(o,max(r,x));}z=e;i=o;}bool n(vec3 v,vec3 f,out float i,out vec3 r,out vec3 o,out float e,out float z){float x,c;vec3 s=f-v;n(v,s,x,c);if(c<x)return false;float y=max(0.,x);v=v+y*s;float m,d,p;vec3 l;float w,g,k;vec3 a;t(s,v,m,d,p,l,w,g,k,a);if(isinf(p)||isinf(k))return false;if(isinf(d)||isinf(g))return false;float u=floor(v.x),b=floor(v.z),T=0.,C=v.y,F,h=t(vec2(u,b),F,z);e=0.;for(i=0.;i<c-y;){if(p<k)i=p,T=v.y+s.y*p,p=p+d,u=u+m,o=l;else i=k,T=v.y+s.y*k,k=k+g,b=b+w,o=a;if(h>T){r=vec3(F/40.,F/40.,1.);if(F<=2.5)r=vec3(.2,.071,.01),e=1.1;else r=vec3(.8,.01,.01),e=1.5;o=vec3(0,1.,0);i=(h-v.y)/s.y;return true;}h=t(vec2(u,b),F,z);if(h>T){if(F>=3.5)r=vec3(.2,.171,.01),e=1.5;else r=vec3(.2,.2,.2),e=1.5;if(z==1.){float D=25.31;if(T<D)z=0.;}return true;}}return false;}float n(float f,vec3 v,vec3 o){float e=(1.-f)/(1.+f);e*=e;float r=-dot(v,o),c=1.-r,i=e+(1.-e)*c*c*c*c*c;return i;}const vec3 i=vec3(5e-06,1.5e-05,.00027)*15.,c=vec3(.00015,.00015,.00027)*15.;vec3 r(float f){return exp(-f*(i+c));}vec3 n(float f,float v){float r=.0003/16.*3.14159*(1.+v*v);vec3 e=vec3(1./(i.x+c.x)*(1.-exp(-f*c.x)),1./(i.y+c.y)*(1.-exp(-f*c.y)),1./(i.z+c.z)*(1.-exp(-f*c.z)));float z=.476;vec3 o=vec3(.002,.0008,.0002)*(1.-z)*(1.-z)/(12.5664*pow(1.+z*z-2.*z*v,1.5));float s=20./(i.x+c.x)*(1.-exp(-f*c.x));return r*e+o*s;}void main(){float i=iTime*2.,c=(30.*i-45.*cos(i)+cos(3.*i)-9.*sin(2.*i))/96.;c+=iTime*.1;vec2 x=2.*(gl_FragCoord.xy/o)-vec2(f/o,1.);vec3 s=vec3(x,-2.),p=vec3(0.,0.,0.);float y=sp[161].y;mat3 m=mat3(cos(y),0,-sin(y),0,1,0,sin(y),0,cos(y));float T=sp[161].x;mat3 u=mat3(1,0,0,0,cos(T),-sin(T),0,sin(T),cos(T));float d=sp[161].z;mat3 k=mat3(cos(d),-sin(d),0,sin(d),cos(d),0,0,0,1);m=m*u*k;vec3 l=sp[160].xyz,b=m*p,F=m*s;b+=l;F+=l;vec3 g=normalize(F-b);float a=1.;vec3 w=vec3(0,0,0);for(int h=2;h>0;h--){vec3 C,D,q,Z;float Y,X=0.;int W=-1;float V=e,U=0.;Z=vec3(1.,1.,0.);for(int S=0;S<v;S++)V=t(V,g,b,sp[S*2].xyz,sp[S*2].w,S,q,D,W);if(W!=-1)Z=sp[W*2+1].xyz,Y=sp[W*2+1].w,X=n(Y,D,g),C=reflect(g,D);vec3 S=b+g;float R;vec3 Q,P;float O,N;if(n(b,S,R,Q,P,N,O)){if(R<V){if(O==1.){float M=25.91;vec3 L=vec3(386.,M,447.),K=(b-L)*512.,J=(S-L)*512.;float I;if(n(K,J,I,Q,P,N,O))V=R+I/512.,Z=Q,Z.z=Z.z*2.,D=P,Y=N,q=b+g*V*.9999,X=n(Y,D,g),C=reflect(normalize(g),D);else{V=R*2.02;b=b+g*V;continue;}}else V=R,Z=Q,D=P,Y=N,q=b+g*V*.9999,X=n(Y,D,g),C=reflect(normalize(g),D);}}vec3 I;float M=t(g,b,-.5,I,P);if(M<=V){Y=1.1;q=b+g*M*.9999;D=P+t(q)*.01;D=normalize(D);X=n(Y,D,g);C=reflect(g,D);W=0;vec3 L=refract(g,D,1.-X);float J;Z=vec3(.05,.05,.15);if(n(q,q+L*100.,J,Q,P,N,O))Z+=Q*exp(-J*40.);W=0;}vec3 L=vec3(0,0,0);if(V>=e){L+=n(V,dot(z,g));w+=L*a;break;}for(int J=0;J<1;J++){bool K=false;vec3 H=q+z*5.;if(n(q,H,i,Q,P,N,O))K=true;if(!K){for(int G=0;G<v;G++){if(t(z,q,sp[G*2].xyz,sp[G*2].w)){K=true;break;}}}if(!K){vec3 G=reflect(-z,D),E=-g;float B=dot(z,D);vec3 A=normalize(E+z);float j=pow(dot(D,A),121.);j=clamp(j,0.,1.);vec3 ab=Z*B;L+=vec3(j,j,j)+ab;}else L+=Z*.02;}L*=r(V);L+=n(V,dot(z,g));w+=L*a*(1.-X);a=a*X;g=C;b=q;}vec3 D=pow(w,vec3(1./2.2));fragColor=vec4(D,1.);}\0\0";
//const int v=80;const float f=1280,o=720;uniform float iTime;uniform vec4 sp[(v+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const vec3 z=normalize(vec3(1.,1.1,1.));const float e=99999.;vec2 p[4]=vec2[4](normalize(vec2(.23,.6556)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.826)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,i=0.;for(int z=0;z<4;z++){float e=v.x*p[z].x+v.z*p[z].y;e=e*(4.-float(z)*.51013)+iTime;float r=1./(float(z)+1.);f+=r*sin(e-.3*cos(e));i+=r*cos(e-.3*sin(e));}return vec3(f,0.,i);}float t(vec3 v,vec3 f,float z,out vec3 i,out vec3 r){if(v.y>=0.)return e;float c=(z-f.y)/v.y;r=vec3(0.,1.f,0.f);i=f+v*c;return c;}float t(float f,vec3 v,vec3 e,vec3 z,float i,int r,out vec3 c,out vec3 o,out int s){vec3 x=z-e;float m=dot(x,v);if(m<0.)return f;else{float t=length(x),y=t*t-m*m;if(y>i)return f;else{float n=sqrt(i-y),d=m-n;if(d<f)return c=e+d*v,o=normalize(c-z),s=r,d;else return f;}}}bool t(vec3 f,vec3 e,vec3 v,float z){vec3 i=v-e;float c=dot(i,f);if(c<0.)return false;else{float r=length(i),o=r*r-c*c;if(o>z)return false;else return true;}}float t(vec2 f,out float v,out float i){vec4 r=texture(terrain,f/512.);v=r.x*5.;i=r.y;return r.x*60.-12.1;}void t(vec3 f,vec3 v,out float r,out float o,out float z,out vec3 i,out float e,out float s,out float c,out vec3 x){if(f.x>0.)r=1.,o=1./f.x,z=o*(1.-fract(v.x)),i=vec3(-1.,0,0);else r=-1.,o=1./-f.x,z=o*fract(v.x),i=vec3(1.,0,0);if(f.z>0.)e=1.,s=1./f.z,c=s*(1.-fract(v.z)),x=vec3(0,0,-1.);else e=-1.,s=1./-f.z,c=s*fract(v.z),x=vec3(0,0,1.);}float n(vec3 v){return max(max(v.x,v.y),v.z);}float s(vec3 v){return min(min(v.x,v.y),v.z);}void n(vec3 f,vec3 v,out float z,out float i){float e=-1000.,o=1000.;if(v.x!=0.){float r=-f.x/v.x,x=(512.-f.x)/v.x;e=max(e,min(r,x));o=min(o,max(r,x));}if(v.z!=0.){float r=-f.z/v.z,x=(512.-f.z)/v.z;e=max(e,min(r,x));o=min(o,max(r,x));}z=e;i=o;}bool n(vec3 v,vec3 f,out float i,out vec3 r,out vec3 o,out float e,out float z){float x,c;vec3 s=f-v;n(v,s,x,c);if(c<x)return false;float y=max(0.,x);v=v+y*s;float m,d,p;vec3 l;float w,g,k;vec3 a;t(s,v,m,d,p,l,w,g,k,a);if(isinf(p)||isinf(k))return false;if(isinf(d)||isinf(g))return false;float u=floor(v.x),b=floor(v.z),T=0.,C=v.y,F,h=t(vec2(u,b),F,z);e=0.;for(i=0.;i<c-y;){if(p<k)i=p,T=v.y+s.y*p,p=p+d,u=u+m,o=l;else i=k,T=v.y+s.y*k,k=k+g,b=b+w,o=a;if(h>T){r=vec3(F/40.,F/40.,1.);if(F<=2.5)r=vec3(.2,.071,.01),e=1.1;else r=vec3(.8,.01,.01),e=1.5;o=vec3(0,1.,0);i=(h-v.y)/s.y;return true;}h=t(vec2(u,b),F,z);if(h>T){if(F>=3.5)r=vec3(.2,.171,.01),e=1.5;else r=vec3(.2,.2,.2),e=1.5;if(z==1.){float D=25.31;if(T<D)z=0.;}return true;}}return false;}float n(float f,vec3 v,vec3 o){float e=(1.-f)/(1.+f);e*=e;float r=-dot(v,o),c=1.-r,i=e+(1.-e)*c*c*c*c*c;return i;}const vec3 i=vec3(5e-06,1.5e-05,.00027)*15.,c=vec3(.00015,.00015,.00027)*15.;vec3 r(float f){return exp(-f*(i+c));}vec3 n(float f,float v){float r=.0003/16.*3.14159*(1.+v*v);vec3 e=vec3(1./(i.x+c.x)*(1.-exp(-f*c.x)),1./(i.y+c.y)*(1.-exp(-f*c.y)),1./(i.z+c.z)*(1.-exp(-f*c.z)));float z=.476;vec3 o=vec3(.002,.0008,.0002)*(1.-z)*(1.-z)/(12.5664*pow(1.+z*z-2.*z*v,1.5));float s=20./(i.x+c.x)*(1.-exp(-f*c.x));return r*e+o*s;}void main(){float i=iTime*2.,c=(30.*i-45.*cos(i)+cos(3.*i)-9.*sin(2.*i))/96.;c+=iTime*.1;vec2 x=2.*(gl_FragCoord.xy/o)-vec2(f/o,1.);vec3 s=vec3(x,-2.),p=vec3(0.,0.,0.);float y=sp[161].y;mat3 m=mat3(cos(y),0,-sin(y),0,1,0,sin(y),0,cos(y));float T=sp[161].x;mat3 u=mat3(1,0,0,0,cos(T),-sin(T),0,sin(T),cos(T));float d=sp[161].z;mat3 k=mat3(cos(d),-sin(d),0,sin(d),cos(d),0,0,0,1);m=m*u*k;vec3 l=sp[160].xyz,b=m*p,F=m*s;b+=l;F+=l;vec3 g=normalize(F-b);float a=1.;vec3 w=vec3(0,0,0);for(int h=2;h>0;h--){vec3 C,D,q,Z;float Y,X=0.;int W=-1;float V=e,U=0.;Z=vec3(1.,1.,0.);for(int S=0;S<v;S++)V=t(V,g,b,sp[S*2].xyz,sp[S*2].w,S,q,D,W);if(W!=-1)Z=sp[W*2+1].xyz,Y=sp[W*2+1].w,X=n(Y,D,g),C=reflect(g,D);vec3 S=b+g;float R;vec3 Q,P;float O,N;if(n(b,S,R,Q,P,N,O)){if(R<V){if(O==1.){float M=25.91;vec3 L=vec3(386.,M,447.),K=(b-L)*512.,J=(S-L)*512.;float I;if(n(K,J,I,Q,P,N,O))V=R+I/512.,Z=Q,Z.z=Z.z*2.,D=P,Y=N,q=b+g*V*.9999,X=n(Y,D,g),C=reflect(normalize(g),D);else{V=R*2.02;b=b+g*V;continue;}}else V=R,Z=Q,D=P,Y=N,q=b+g*V*.9999,X=n(Y,D,g),C=reflect(normalize(g),D);}}vec3 I;float M=t(g,b,-.5,I,P);if(M<=V){Y=1.1;q=b+g*M*.9999;D=P+t(q)*.01;D=normalize(D);X=n(Y,D,g);C=reflect(g,D);W=0;vec3 L=refract(g,D,1.-X);float J;Z=vec3(.05,.05,.15);if(n(q,q+L*100.,J,Q,P,N,O))Z+=Q*exp(-J*40.);W=0;}vec3 L=vec3(0,0,0);if(V>=e){L+=n(V,dot(z,g));w+=L*a;break;}for(int J=0;J<1;J++){bool K=false;vec3 H,G;float E;vec3 B=q+z*5.;if(n(q,B,i,H,G,E,O))K=true;if(!K){for(int A=0;A<v;A++){if(t(z,q,sp[A*2].xyz,sp[A*2].w)){K=true;break;}}}if(!K){vec3 A=reflect(-z,D),j=-g;float ab=dot(z,D);vec3 ac=normalize(j+z);float ad=pow(dot(D,ac),121.);ad=clamp(ad,0.,1.);vec3 ae=Z*ab;L+=vec3(ad,ad,ad)+ae;}else L+=Z*.02;}L*=r(V);L+=n(V,dot(z,g));w+=L*a*(1.-X);a=a*X;g=C;b=q;}vec3 D=pow(w,vec3(1./2.2));fragColor=vec4(D,1.);}\0\0";
// #define steps 565.0
// const int v=80;const float f=1280,o=720;uniform float iTime;uniform vec4 spheres[(v+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const vec3 z=normalize(vec3(1.,1.1,1.));const float e=99999.;vec2 s[4]=vec2[4](normalize(vec2(.23,.6556)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.826)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,i=0.;for(int z=0;z<4;z++){float e=v.x*s[z].x+v.z*s[z].y;e=e*(4.-float(z)*.51013)+iTime;float m=1./(float(z)+1.);f+=m*sin(e-.3*cos(e));i+=m*cos(e-.3*sin(e));}return vec3(f,0.,i);}float t(vec3 v,vec3 f,float z,out vec3 i,out vec3 r){if(v.y>=0.)return e;float s=(z-f.y)/v.y;r=vec3(0.,1.f,0.f);i=f+v*s;return s;}float t(float f,vec3 v,vec3 e,vec3 z,float i,int m,out vec3 s,out vec3 o,out int c){vec3 x=z-e;float r=dot(x,v);if(r<0.)return f;else{float t=length(x),y=t*t-r*r;if(y>i)return f;else{float n=sqrt(i-y),d=r-n;if(d<f)return s=e+d*v,o=normalize(s-z),c=m,d;else return f;}}}bool t(vec3 f,vec3 e,vec3 v,float z){vec3 i=v-e;float s=dot(i,f);if(s<0.)return false;else{float m=length(i),o=m*m-s*s;if(o>z)return false;else return true;}}float t(vec2 f,out float v,out float i){vec4 m=texture(terrain,f/512.);v=m.x*5.;i=m.y;return m.x*60.-12.1;}void t(vec3 f,vec3 v,out float z,out float m,out float o,out vec3 s,out float r,out float i,out float e,out vec3 c){if(f.x>0.)z=1.,m=1./f.x,o=m*(1.-fract(v.x)),s=vec3(-1.,0,0);else z=-1.,m=1./-f.x,o=m*fract(v.x),s=vec3(1.,0,0);if(f.z>0.)r=1.,i=1./f.z,e=i*(1.-fract(v.z)),c=vec3(0,0,-1.);else r=-1.,i=1./-f.z,e=i*fract(v.z),c=vec3(0,0,1.);}float n(vec3 v){return max(max(v.x,v.y),v.z);}float r(vec3 v){return min(min(v.x,v.y),v.z);}void n(vec3 f,vec3 v,out float z,out float i){float e=-1000.,o=1000.;if(v.x!=0.){float s=-f.x/v.x,c=(512.-f.x)/v.x;e=max(e,min(s,c));o=min(o,max(s,c));}if(v.z!=0.){float s=-f.z/v.z,c=(512.-f.z)/v.z;e=max(e,min(s,c));o=min(o,max(s,c));}z=e;i=o;}bool n(vec3 v,vec3 f,float z,out float i,out vec3 s,out vec3 o,out float e,out float c){float m,y;vec3 r=f-v;n(v,r,m,y);if(y<m)return false;float x=max(0.,m);v=v+x*r;float d,w,p;vec3 l;float g,a,k;vec3 u;t(r,v,d,w,p,l,g,a,k,u);if(isinf(p)||isinf(k))return false;if(isinf(w)||isinf(a))return false;float h=floor(v.x),b=floor(v.z),T=0.,C=v.y,F,D=t(vec2(h,b),F,c);e=0.;for(i=0.;i<y-x;){if(p<k)i=p,T=v.y+r.y*p,p=p+w,h=h+d,o=l;else i=k,T=v.y+r.y*k,k=k+a,b=b+g,o=u;if(D>T){s=vec3(F/40.,F/40.,1.);if(F<=2.5)s=vec3(.2,.071,.01),e=1.1;else s=vec3(.8,.01,.01),e=1.5;o=vec3(0,1.,0);i=(D-v.y)/r.y;return true;}D=t(vec2(h,b),F,c);if(D>T){if(F>=3.5)s=vec3(.2,.171,.01),e=1.5;else s=vec3(.2,.2,.2),e=1.5;if(c==1.){float q=25.31;if(T<q)c=0.;}return true;}}return false;}float n(float f,vec3 v,vec3 o){float e=(1.-f)/(1.+f);e*=e;float s=-dot(v,o),c=1.-s,i=e+(1.-e)*c*c*c*c*c;return i;}const vec3 i=vec3(5e-06,1.5e-05,.00027)*15.,c=vec3(.00015,.00015,.00027)*15.;vec3 m(float f){return exp(-f*(i+c));}vec3 m(float v,float f){vec3 e=4.*vec3(27.,4.,1.)/pow(v*10.,4.);return e;}vec3 n(float f,float v){float e=.0003/16.*3.14159*(1.+v*v);vec3 s=vec3(1./(i.x+c.x)*(1.-exp(-f*c.x)),1./(i.y+c.y)*(1.-exp(-f*c.y)),1./(i.z+c.z)*(1.-exp(-f*c.z)));float z=.476;vec3 m=vec3(.002,.0008,.0002)*(1.-z)*(1.-z)/(12.5664*pow(1.+z*z-2.*z*v,1.5));float r=20./(i.x+c.x)*(1.-exp(-f*c.x));return e*s+m*r;}void main(){float s=iTime*2.,i=(30.*s-45.*cos(s)+cos(3.*s)-9.*sin(2.*s))/96.;i+=iTime*.1;vec2 r=2.*(gl_FragCoord.xy/o)-vec2(f/o,1.);vec3 c=vec3(r,-2.),p=vec3(0.,0.,0.);float x=spheres[161].y;mat3 d=mat3(cos(x),0,-sin(x),0,1,0,sin(x),0,cos(x));float y=spheres[161].x;mat3 h=mat3(1,0,0,0,cos(y),-sin(y),0,sin(y),cos(y));float T=spheres[161].z;mat3 k=mat3(cos(T),-sin(T),0,sin(T),cos(T),0,0,0,1);d=d*h*k;vec3 l=spheres[160].xyz,b=d*p,F=d*c;b+=l;F+=l;vec3 w=normalize(F-b);float u=1.;vec3 g=vec3(0,0,0);for(int D=2;D>0;D--){vec3 a,C,q,Z;float Y,X=0.;int W=-1;float V=e,U=0.;Z=vec3(1.,1.,0.);for(int S=0;S<v;S++)V=t(V,w,b,spheres[S*2].xyz,spheres[S*2].w,S,q,C,W);if(W!=-1)Z=spheres[W*2+1].xyz,Y=spheres[W*2+1].w,X=n(Y,C,w),a=reflect(w,C);vec3 S=b+w;float R;vec3 Q,P;float O,N;if(n(b,S,steps,R,Q,P,N,O)){if(R<V){if(O==1.){float M=25.91;vec3 L=vec3(386.,M,447.),K=(b-L)*512.,J=(S-L)*512.;float I;if(n(K,J,1512,I,Q,P,N,O))V=R+I/512.,Z=Q,Z.z=Z.z*2.,C=P,Y=N,q=b+w*V*.9999,X=n(Y,C,w),a=reflect(normalize(w),C);else{Z=vec3(.032,.04,.1802);C=P;Y=1.2;V=R*2.02;q=b+w*V;X=.59;a=w;b=q;w=a;continue;}}else V=R,Z=Q,C=P,Y=N,q=b+w*V*.9999,X=n(Y,C,w),a=reflect(normalize(w),C);}}vec3 I;float M=t(w,b,-.5,I,P);if(M<=V){Y=1.1;q=b+w*M*.9999;C=P+t(q)*.01;C=normalize(C);X=n(Y,C,w);a=reflect(w,C);W=0;vec3 L=refract(w,C,1.-X);float J;Z=vec3(.05,.05,.15);if(n(q,q+L*100.,115,J,Q,P,N,O))Z+=Q*exp(-J*40.);W=0;}vec3 L=vec3(0,0,0);if(V>=e){L+=n(V,dot(z,w));g+=L*u;break;}for(int J=0;J<1;J++){bool K=false;vec3 H,G;float E;vec3 B=q+z*5.;if(n(q,B,20.,s,H,G,E,O))K=true;if(!K){for(int A=0;A<v;A++){if(t(z,q,spheres[A*2].xyz,spheres[A*2].w)){K=true;break;}}}if(!K){vec3 A=reflect(-z,C),j=-w;float ab=dot(z,C);vec3 ac=normalize(j+z);float ad=pow(dot(C,ac),121.);ad=clamp(ad,0.,1.);vec3 ae=Z*ab;L+=vec3(ad,ad,ad)+ae;}else L+=Z*.02;}L*=m(V);L+=n(V,dot(z,w));g+=L*u*(1.-X);u=u*X;w=a;b=q;}vec3 a=pow(g,vec3(1./2.2));fragColor=vec4(a,1.);}\0\0";

// #version 330 core
// #define steps 165.0
// const int v=80;const float f=1280,o=720;uniform float iTime;uniform vec4 spheres[(v+2)*2];uniform sampler2D terrain;in vec4 gl_FragCoord;out vec4 fragColor;const vec3 x=normalize(vec3(1.,1.1,1.));const float e=99999.;vec2 s[4]=vec2[4](normalize(vec2(.23,.6556)),normalize(vec2(.83,-.26)),normalize(vec2(.13,-.826)),normalize(vec2(-.2,.55)));vec3 t(vec3 v){float f=0.,o=0.;for(int i=0;i<4;i++){float e=v.x*s[i].x+v.z*s[i].y;e=e*(4.-float(i)*.51013)+iTime;float r=1./(float(i)+1.);f+=r*sin(e-.3*cos(e));o+=r*cos(e-.3*sin(e));}return vec3(f,0.,o);}float t(vec3 v,vec3 f,float i,out vec3 r,out vec3 x){if(v.y>=0.)return e;float s=(i-f.y)/v.y;x=vec3(0.,1.f,0.f);r=f+v*s;return s;}float t(float v,vec3 f,vec3 e,vec3 x,float i,int s,out vec3 r,out vec3 o,out int c){vec3 z=x-e;float n=dot(z,f);if(n<0.)return v;else{float t=length(z),y=t*t-n*n;if(y>i)return v;else{float d=sqrt(i-y),k=n-d;if(k<v)return r=e+k*f,o=normalize(r-x),c=s,k;else return v;}}}bool t(vec3 v,vec3 f,vec3 s,float x){vec3 i=s-f;float e=dot(i,v);if(e<0.)return false;else{float r=length(i),o=r*r-e*e;if(o>x)return false;else return true;}}float t(vec2 f,out float v){f+=vec2(270.,252.);vec4 r=texture(terrain,f/512.);v=r.x*5.;return r.x*60.-12.1;}void t(vec3 v,vec3 f,out float r,out float o,out float s,out vec3 x,out float i,out float e,out float c,out vec3 z){vec3 t=f-v;if(t.x>0.)r=1.,o=1./t.x,s=o*(1.-fract(v.x)),x=vec3(-1.,0,0);else r=-1.,o=1./-t.x,s=o*fract(v.x),x=vec3(1.,0,0);if(t.z>0.)i=1.,e=1./t.z,c=e*(1.-fract(v.z)),z=vec3(0,0,-1.);else i=-1.,e=1./-t.z,c=e*fract(v.z),z=vec3(0,0,1.);}bool t(vec3 v,vec3 f,float e,out float i,out vec3 r,out vec3 o,out float x){vec3 c=f-v;float s,z,n;vec3 d;float k,y,p;vec3 m;t(v,f,s,z,n,d,k,y,p,m);float l=floor(v.x),w=floor(v.z),a=0.,u=v.y,g,b=t(vec2(l,w),g);x=0.;for(float h=0.;h<e;h++){if(n<p)i=n,a=v.y+c.y*n,n=n+z,l=l+s,o=d;else i=p,a=v.y+c.y*p,p=p+y,w=w+k,o=m;if(b>a){r=vec3(g/40.,g/40.,1.);if(g<=2.5)r=vec3(.2,.071,.01),x=1.1;else r=vec3(.8,.01,.01),x=1.5;o=vec3(0,1.,0);i=(b-v.y)/c.y;return true;}b=t(vec2(l,w),g);if(b>a){r=vec3(g,g,1.);if(g>=3.5)r=vec3(.2,.171,.01),x=1.5;else r=vec3(.8,.01,.01),x=1.5;return true;}}return false;}float t(float v,vec3 f,vec3 o){float e=(1.-v)/(1.+v);e*=e;float r=-dot(f,o),s=1.-r,x=e+(1.-e)*s*s*s*s*s;return x;}const vec3 i=vec3(5e-06,1.5e-05,.00027)*15.,c=vec3(.00015,.00015,.00027)*15.;vec3 r(float v){return exp(-v*(i+c));}vec3 r(float v,float f){vec3 r=4.*vec3(27.,4.,1.)/pow(v*10.,4.);return r;}vec3 n(float v,float f){float r=.0003/16.*3.14159*(1.+f*f);vec3 s=vec3(1./(i.x+c.x)*(1.-exp(-v*c.x)),1./(i.y+c.y)*(1.-exp(-v*c.y)),1./(i.z+c.z)*(1.-exp(-v*c.z)));float x=.476;vec3 e=vec3(.002,.0008,.0002)*(1.-x)*(1.-x)/(12.5664*pow(1.+x*x-2.*x*f,1.5));float o=20./(i.x+c.x)*(1.-exp(-v*c.x));return r*s+e*o;}void main(){float i=iTime*2.,s=(30.*i-45.*cos(i)+cos(3.*i)-9.*sin(2.*i))/96.;s+=iTime*.1;vec2 z=2.*(gl_FragCoord.xy/o)-vec2(f/o,1.);vec3 c=vec3(z,-2.),p=vec3(0.,0.,0.);float g=spheres[161].y;mat3 m=mat3(cos(g),0,-sin(g),0,1,0,sin(g),0,cos(g));float y=spheres[161].x;mat3 d=mat3(1,0,0,0,cos(y),-sin(y),0,sin(y),cos(y));m=m*d;vec3 l=spheres[160].xyz,w=m*p,b=m*c;w+=l;b+=l;vec3 k=normalize(b-w);float u=1.;vec3 h=vec3(0,0,0);for(int a=2;a>0;a--){vec3 T,C,F,D;float q,Z=0.;int Y=-1;float X=e,W=0.;D=vec3(1.,1.,0.);for(int V=0;V<v;V++)X=t(X,k,w,spheres[V*2].xyz,spheres[V*2].w,V,F,C,Y);if(Y!=-1)D=spheres[Y*2+1].xyz,q=spheres[Y*2+1].w,Z=t(q,C,k),T=reflect(k,C);vec3 V=w+k;float U;vec3 S,R;float Q;if(t(w,V,steps,U,S,R,Q)){if(U<X)X=U,D=S,C=R,q=Q,F=w+k*X*.9999,Z=t(q,C,k),T=reflect(normalize(k),C);}vec3 P;float O=t(k,w,-.5,P,R);if(O<=X)X=O,q=1.7,D=vec3(.05,.05,.05),F=w+k*X*.9999,C=R+t(F)*.005,C=normalize(C),Z=t(q,C,k),T=reflect(k,C),Y=0;vec3 N=vec3(0,0,0);if(X>=e){N+=n(X,dot(x,k));h+=N*u;break;}for(int M=0;M<1;M++){bool L=false;vec3 K,J;float I;vec3 H=F+x*5.;if(!L){for(int G=0;G<v;G++){if(t(x,F,spheres[G*2].xyz,spheres[G*2].w)){L=true;break;}}}if(!L){vec3 G=reflect(-x,C),E=-k;float B=dot(x,C);vec3 A=normalize(E+x);float j=pow(dot(C,A),121.);j=clamp(j,0.,1.);vec3 ab=D*B;N+=vec3(j,j,j)+ab;}else N+=D*.02;}N*=r(X);if(Y!=0)N+=r(X,dot(x,k));N+=n(X,dot(x,k));h+=N*u*(1.-Z);u=u*Z;k=T;w=F;}vec3 X=pow(h,vec3(1./2.2));fragColor=vec4(X,1.);}\0\0";
